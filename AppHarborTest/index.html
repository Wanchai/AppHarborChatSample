<!DOCTYPE html>
<html>
<head>
    <title>AppHarbor Chat</title>
    <style type="text/css">
        body {
            font-family: Verdana, Geneva, Tahoma, sans-serif;
        }

        .container {
            display: flex;
            margin: 0 auto;
            width: 600px;
        }

        .item1, .item2 {
            background-color: #eee;
            margin: 10px;
            padding: 10px;
        }

        .item1 {
            flex-grow: 3;
            order: 1;
        }

        .item2 {
            flex-grow: 2;
            order: 2;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="item1">
            <input type="text" width="30" id="message" />
            <input type="hidden" id="displayname" />
            <ul id="discussion"></ul>
        </div>
        <div class="item2">
            <ul id="people"></ul>
        </div>
    </div>

    <!--Script references. -->
    <!--Reference the jQuery library. -->
    <script src="Scripts/jquery-1.6.4.min.js"></script>
    <!--Reference the SignalR library. -->
    <script src="Scripts/jquery.signalR-2.2.1.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="signalr/hubs"></script>
    <!--Add script to update the page and send messages.-->
    <script type="text/javascript">
        $(function () {
            console.log('OK1');

            // Declare a proxy to reference the hub.
            var chat = $.connection.chatHub;
            // Create a function that the hub can call to broadcast messages.
            chat.client.broadcastMessage = function (name, message) {
                // Html encode display name and message.
                var encodedName = $('<div />').text(name).html();
                var encodedMsg = $('<div />').text(message).html();
                // Add the message to the page.
                $('#discussion').append('<li><strong>' + encodedName
                    + '</strong>:&nbsp;&nbsp;' + encodedMsg + '</li>');
            };

            chat.client.refreshUser = function (list) {
                var lst = "";
                $.each(list, function (key, value) {
                    console.log('OK2: ' + value);
                    lst += '<li><strong>' + value + '</strong></li>';
                });

                $('#people').html(lst);

                //console.log('OK2: ' + users);
            };

            // Get the user name and store it to prepend to messages.
            var name = prompt('Enter your name:', '');

            $('#displayname').val(name);

            // Set initial focus to message input box.
            $('#message').focus();

            // Start the connection.
            $.connection.hub.start().done(function () {
                chat.server.addUser(name);

                $('#message').bind('keypress', function (e) {
                    var p = e.which;
                    if (p == 13) {
                        // Call the Send method on the hub.
                        chat.server.send($('#displayname').val(), $('#message').val());
                        // Clear text box and reset focus for next comment.
                        $('#message').val('').focus();
                    }
                });

            });
            $(window).unload(function () {
                console.log('OK5');

                //chat.server.delete
                //chat.server.deleteuser($('#displayname').val());
                //return 'Are you sure you want to leave?';
            });
        });
    </script>
</body>
</html>